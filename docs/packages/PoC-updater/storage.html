<!DOCTYPE html>
<!--
 Copyright 2021 Red Hat, Inc

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<html>
<head>
<title>storage.go</title>
<meta charset="utf-8"/>
<style type="text/css">body {
    background: rgb(225, 225, 225);
    margin: 0px;
    padding: 0px;
}

#docgo p {
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo div {
    display: inline;
}

#docgo #background {
    position: fixed;
    top: 0; left: 525px; right: 0; bottom: 0;
    background: rgb(47, 47, 47);
    border-left: 1px solid #e5e5ee;
    z-index: -1;
}

#docgo .keyword {
    color: rgb(250, 200, 100);
}

#docgo .literal {
    color: rgb(140, 190, 100);
}

#docgo .ident {
    color: white;
}

#docgo .operator {
    color: white;
}

#docgo .comment {
}

#docgo h1, h2, h3, h4, h5 {
    text-align: left;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo h1 {
    margin-top: 40px;
}

#docgo .doc {
    vertical-align: top;
    font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    font-size: 15px;
    line-height: 22px;
    color: black;
    min-width: 450px;
    max-width: 450px;
    padding-top: 10px;
    padding-right: 25px;
    padding-bottom: 1px;
    padding-left: 50px;
    overflow-x: hidden;
}

#docgo .code {
    min-width: 650px;
    max-width: 650px;
    padding-left: 25px;
    padding-right: 15px;
    border-left: 1px;
    overflow-x: hidden;
    vertical-align: top;
}

#docgo .code pre code  {
    font-size: 12px;
    line-height: 18px;
    font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
    color: rgb(120, 120, 120);
}
</style>
</head>
<body>
<div id="docgo">
  <div id="background"></div>
  <table>
    <thead><tr><th class="doc"><h1>storage.go</h1></th><th class="code"></th></tr></thead>
    <tbody>
      
      <tr class="section">
	<td class="doc"><p>Copyright 2021 Red Hat, Inc</p>

<p>Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>

<pre><code> http://www.apache.org/licenses/LICENSE-2.0
</code></pre>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</td>
	<td class="code"><pre><code><div class="keyword">package</div> <div class="ident">main</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>This source file contains an implementation of interface between Go code and
(almost any) SQL database like PostgreSQL, SQLite, or MariaDB.</p>

<p>It is possible to configure connection to selected database by using
StorageConfiguration structure. Currently that structure contains two
configurable parameter:</p>

<p>Driver - a SQL driver, like &quot;sqlite3&quot;, &quot;pq&quot; etc.
DataSource - specification of data source. The content of this parameter depends on the database used.</p>
</td>
	<td class="code"><pre><code>
<div class="keyword">import</div> <div class="operator">(</div>
	<div class="literal">&#34;database/sql&#34;</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>&quot;errors&quot;</p>
</td>
	<td class="code"><pre><code>	<div class="literal">&#34;fmt&#34;</div><div class="operator"></div>
	<div class="literal">&#34;strings&#34;</div><div class="operator"></div>
	<div class="literal">&#34;time&#34;</div><div class="operator"></div>

	<div class="ident">_</div> <div class="literal">&#34;github.com/lib/pq&#34;</div>           <div class="operator"></div><div class="comment">// PostgreSQL database driver</div>
	<div class="ident">_</div> <div class="literal">&#34;github.com/mattn/go-sqlite3&#34;</div> <div class="operator"></div><div class="comment">// SQLite database driver</div>

	<div class="literal">&#34;github.com/RedHatInsights/ccx-notification-service/conf&#34;</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>&quot;github.com/RedHatInsights/ccx-notification-service/types&quot;</p>
</td>
	<td class="code"><pre><code>	<div class="literal">&#34;github.com/rs/zerolog/log&#34;</div><div class="operator"></div>
	<div class="literal">&#34;updater/types&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Storage represents an interface to almost any database or storage system</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">Storage</div> <div class="keyword">interface</div> <div class="operator">{</div>
	<div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">ReadReportForCluster</div><div class="operator">(</div>
		<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">ReadClusterList</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterEntry</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">ReadNotificationTypes</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">NotificationType</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">ReadStates</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">State</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">ReadReportForClusterAtTime</div><div class="operator">(</div>
		<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">updatedAt</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">ReadReportForClusterAtOffset</div><div class="operator">(</div>
		<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">offset</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">ReadLastNNotificationRecords</div><div class="operator">(</div>
		<div class="ident">clusterEntry</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterEntry</div><div class="operator">,</div>
		<div class="ident">numberOfRecords</div> <div class="ident">int</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">NotificationRecord</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">WriteNotificationRecord</div><div class="operator">(</div>
		<div class="ident">notificationRecord</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">NotificationRecord</div><div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">WriteNotificationRecordForCluster</div><div class="operator">(</div>
		<div class="ident">clusterEntry</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterEntry</div><div class="operator">,</div>
		<div class="ident">notificationTypeID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">NotificationTypeID</div><div class="operator">,</div>
		<div class="ident">stateID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">StateID</div><div class="operator">,</div>
		<div class="ident">report</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">,</div>
		<div class="ident">notifiedAt</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">,</div>
		<div class="ident">errorLog</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">WriteNotificationRecordImpl</div><div class="operator">(</div>
		<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">accountNumber</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">AccountNumber</div><div class="operator">,</div>
		<div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">notificationTypeID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">NotificationTypeID</div><div class="operator">,</div>
		<div class="ident">stateID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">StateID</div><div class="operator">,</div>
		<div class="ident">report</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">,</div>
		<div class="ident">updatedAt</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">,</div>
		<div class="ident">notifiedAt</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">,</div>
		<div class="ident">errorLog</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">CleanupNewReportsForOrganization</div><div class="operator">(</div><div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">maxAge</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">int</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">CleanupOldReportsForOrganization</div><div class="operator">(</div><div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">maxAge</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">int</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DBStorage is an implementation of Storage interface that use selected SQL like database
like SQLite, PostgreSQL, MariaDB, RDS etc. That implementation is based on the standard
sql package. It is possible to configure connection via Configuration structure.
SQLQueriesLog is log for sql queries, default is nil which means nothing is logged</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">DBStorage</div> <div class="keyword">struct</div> <div class="operator">{</div>
	<div class="ident">connection</div>   <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator"></div>
	<div class="ident">dbDriverType</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>error messages</p>
</td>
	<td class="code"><pre><code><div class="keyword">const</div> <div class="operator">(</div>
	<div class="ident">unableToCloseDBRowsHandle</div> <div class="operator">=</div> <div class="literal">&#34;Unable to close DB rows handle&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>other messages</p>
</td>
	<td class="code"><pre><code><div class="keyword">const</div> <div class="operator">(</div>
	<div class="ident">OrgIDMessage</div>       <div class="operator">=</div> <div class="literal">&#34;Organization ID&#34;</div><div class="operator"></div>
	<div class="ident">ClusterNameMessage</div> <div class="operator">=</div> <div class="literal">&#34;Cluster name&#34;</div><div class="operator"></div>
	<div class="ident">TimestampMessage</div>   <div class="operator">=</div> <div class="literal">&#34;Timestamp (notified_at/updated_at)&#34;</div><div class="operator"></div>
	<div class="ident">MaxAgeAttribute</div>    <div class="operator">=</div> <div class="literal">&#34;max age&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>SQL statements</p>
</td>
	<td class="code"><pre><code><div class="keyword">const</div> <div class="operator">(</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Delete older records from new_reports table for given organization ID</p>
</td>
	<td class="code"><pre><code>	<div class="ident">deleteOldRecordsFromNewReportsTable</div> <div class="operator">=</div> <div class="literal">`
                DELETE
		  FROM new_reports
		 WHERE org_id = $1
		   AND updated_at &lt; NOW() - $2::INTERVAL 
`</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Delete older records from reported table for given organization ID</p>
</td>
	<td class="code"><pre><code>	<div class="ident">deleteOldRecordsFromReportedTable</div> <div class="operator">=</div> <div class="literal">`
                DELETE
		  FROM reported
		 WHERE org_id = $1
		   AND updated_at &lt; NOW() - $2::INTERVAL
`</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>NewStorage function creates and initializes a new instance of Storage interface</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">NewStorage</div><div class="operator">(</div><div class="ident">configuration</div> <div class="ident">conf</div><div class="operator">.</div><div class="ident">StorageConfiguration</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">DBStorage</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">driverType</div><div class="operator">,</div> <div class="ident">driverName</div><div class="operator">,</div> <div class="ident">dataSource</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">initAndGetDriver</div><div class="operator">(</div><div class="ident">configuration</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div>
		<div class="literal">&#34;Making connection to data storage, driver=%s datasource=%s&#34;</div><div class="operator">,</div>
		<div class="ident">driverName</div><div class="operator">,</div> <div class="ident">dataSource</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>

	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sql</div><div class="operator">.</div><div class="ident">Open</div><div class="operator">(</div><div class="ident">driverName</div><div class="operator">,</div> <div class="ident">dataSource</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Can not connect to data storage&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">NewFromConnection</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="ident">driverType</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>NewFromConnection function creates and initializes a new instance of Storage interface from prepared connection</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">NewFromConnection</div><div class="operator">(</div><div class="ident">connection</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">dbDriverType</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator">)</div> <div class="operator">*</div><div class="ident">DBStorage</div> <div class="operator">{</div>
	<div class="keyword">return</div> <div class="operator">&amp;</div><div class="ident">DBStorage</div><div class="operator">{</div>
		<div class="ident">connection</div><div class="operator">:</div>   <div class="ident">connection</div><div class="operator">,</div>
		<div class="ident">dbDriverType</div><div class="operator">:</div> <div class="ident">dbDriverType</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>initAndGetDriver initializes driver(with logs if logSQLQueries is true),
checks if it's supported and returns driver type, driver name, dataSource and error</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">initAndGetDriver</div><div class="operator">(</div><div class="ident">configuration</div> <div class="ident">conf</div><div class="operator">.</div><div class="ident">StorageConfiguration</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">driverType</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator">,</div> <div class="ident">driverName</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">dataSource</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">err</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>var driver sql_driver.Driver</p>
</td>
	<td class="code"><pre><code>	<div class="ident">driverName</div> <div class="operator">=</div> <div class="ident">configuration</div><div class="operator">.</div><div class="ident">Driver</div><div class="operator"></div>

	<div class="keyword">switch</div> <div class="ident">driverName</div> <div class="operator">{</div>
	<div class="keyword">case</div> <div class="literal">&#34;sqlite3&#34;</div><div class="operator">:</div>
		<div class="ident">driverType</div> <div class="operator">=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverSQLite3</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>driver = &amp;sqlite3.SQLiteDriver{}
dataSource = configuration.SQLiteDataSource</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">case</div> <div class="literal">&#34;postgres&#34;</div><div class="operator">:</div>
		<div class="ident">driverType</div> <div class="operator">=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverPostgres</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>driver = &amp;pq.Driver{}</p>
</td>
	<td class="code"><pre><code>		<div class="ident">dataSource</div> <div class="operator">=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div>
			<div class="literal">&#34;postgresql://%v:%v@%v:%v/%v?%v&#34;</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGUsername</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGPassword</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGHost</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGPort</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGDBName</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGParams</div><div class="operator">,</div>
		<div class="operator">)</div><div class="operator"></div>
	<div class="keyword">default</div><div class="operator">:</div>
		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;driver %v is not supported&#34;</div><div class="operator">,</div> <div class="ident">driverName</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Close method closes the connection to database. Needs to be called at the end of application lifecycle.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Closing connection to data storage&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Can not close connection to data storage&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ReadNotificationTypes method read all notification types from the database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">ReadNotificationTypes</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">NotificationType</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">notificationTypes</div> <div class="operator">=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">NotificationType</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">&#34;SELECT id, value, frequency, comment FROM notification_types ORDER BY id&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">notificationTypes</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">unableToCloseDBRowsHandle</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="operator">(</div>
			<div class="ident">id</div>        <div class="ident">types</div><div class="operator">.</div><div class="ident">NotificationTypeID</div><div class="operator"></div>
			<div class="ident">value</div>     <div class="ident">string</div><div class="operator"></div>
			<div class="ident">frequency</div> <div class="ident">string</div><div class="operator"></div>
			<div class="ident">comment</div>   <div class="ident">string</div><div class="operator"></div>
		<div class="operator">)</div><div class="operator"></div>

		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">id</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">value</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">frequency</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">comment</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">if</div> <div class="ident">closeErr</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">closeErr</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">closeErr</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">unableToCloseDBRowsHandle</div><div class="operator">)</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">notificationTypes</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
		<div class="ident">notificationTypes</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">notificationTypes</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">NotificationType</div><div class="operator">{</div>
			<div class="ident">ID</div><div class="operator">:</div> <div class="ident">id</div><div class="operator">,</div> <div class="ident">Value</div><div class="operator">:</div> <div class="ident">value</div><div class="operator">,</div> <div class="ident">Frequency</div><div class="operator">:</div> <div class="ident">frequency</div><div class="operator">,</div> <div class="ident">Comment</div><div class="operator">:</div> <div class="ident">comment</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">notificationTypes</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ReadStates method reads all possible notification states from the database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">ReadStates</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">State</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">states</div> <div class="operator">=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">State</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">&#34;SELECT id, value, comment FROM states ORDER BY id&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">states</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">unableToCloseDBRowsHandle</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="operator">(</div>
			<div class="ident">id</div>      <div class="ident">types</div><div class="operator">.</div><div class="ident">StateID</div><div class="operator"></div>
			<div class="ident">value</div>   <div class="ident">string</div><div class="operator"></div>
			<div class="ident">comment</div> <div class="ident">string</div><div class="operator"></div>
		<div class="operator">)</div><div class="operator"></div>

		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">id</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">value</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">comment</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">if</div> <div class="ident">closeErr</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">closeErr</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">closeErr</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">unableToCloseDBRowsHandle</div><div class="operator">)</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">states</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
		<div class="ident">states</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">states</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">State</div><div class="operator">{</div>
			<div class="ident">ID</div><div class="operator">:</div> <div class="ident">id</div><div class="operator">,</div> <div class="ident">Value</div><div class="operator">:</div> <div class="ident">value</div><div class="operator">,</div> <div class="ident">Comment</div><div class="operator">:</div> <div class="ident">comment</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">states</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ReadClusterList method creates list of clusters from all the rows in new_reports table.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">ReadClusterList</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterEntry</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">clusterList</div> <div class="operator">=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterEntry</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">&#34;SELECT org_id, account_number, cluster, kafka_offset, updated_at FROM new_reports ORDER BY updated_at&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">clusterList</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">unableToCloseDBRowsHandle</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="operator">(</div>
			<div class="ident">clusterName</div>   <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator"></div>
			<div class="ident">orgID</div>         <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator"></div>
			<div class="ident">accountNumber</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">AccountNumber</div><div class="operator"></div>
			<div class="ident">kafkaOffset</div>   <div class="ident">types</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator"></div>
			<div class="ident">updatedAt</div>     <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator"></div>
		<div class="operator">)</div><div class="operator"></div>

		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">orgID</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">accountNumber</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">clusterName</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">kafkaOffset</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">updatedAt</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">if</div> <div class="ident">closeErr</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">closeErr</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">closeErr</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">unableToCloseDBRowsHandle</div><div class="operator">)</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">clusterList</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
		<div class="ident">clusterList</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">clusterList</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterEntry</div><div class="operator">{</div>
			<div class="ident">OrgID</div><div class="operator">:</div>         <div class="ident">orgID</div><div class="operator">,</div>
			<div class="ident">AccountNumber</div><div class="operator">:</div> <div class="ident">accountNumber</div><div class="operator">,</div>
			<div class="ident">ClusterName</div><div class="operator">:</div>   <div class="ident">clusterName</div><div class="operator">,</div>
			<div class="ident">KafkaOffset</div><div class="operator">:</div>   <div class="ident">kafkaOffset</div><div class="operator">,</div>
			<div class="ident">UpdatedAt</div><div class="operator">:</div>     <div class="ident">updatedAt</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">clusterList</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ReadReportForClusterAtTime reads result (health status) for selected cluster
and given timestamp. It is possible that there are more reports stored for a
cluster, so it is needed to specify timestamp to select just one such
report.</p>

<p>See also: ReadReportForClusterAtOffset</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">ReadReportForClusterAtTime</div><div class="operator">(</div>
	<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
	<div class="ident">updatedAt</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">report</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>explicit conversion is needed there - SQL library issue</p>
</td>
	<td class="code"><pre><code>	<div class="ident">timestamp</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator">(</div><div class="ident">updatedAt</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div>
		<div class="literal">&#34;SELECT report FROM new_reports WHERE org_id = $1 AND cluster = $2 AND updated_at = $3;&#34;</div><div class="operator">,</div>
		<div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div> <div class="ident">timestamp</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">report</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">report</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">report</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ReadReportForClusterAtOffset reads result (health status) for selected cluster
and given Kafka offset. It is possible that there are more reports stored for a
cluster, so it is needed to specify Kafka offset to select just one such
report.</p>

<p>See also: ReadReportForClusterAtTime</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">ReadReportForClusterAtOffset</div><div class="operator">(</div>
	<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
	<div class="ident">kafkaOffset</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">report</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div>
		<div class="literal">&#34;SELECT report FROM new_reports WHERE org_id = $1 AND cluster = $2 AND kafka_offset = $3;&#34;</div><div class="operator">,</div>
		<div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div> <div class="ident">kafkaOffset</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">report</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">report</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">report</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ReadReportForCluster reads the latest result (health status) for selected
cluster</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">ReadReportForCluster</div><div class="operator">(</div>
	<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">updatedAt</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">report</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>query to retrieve just the latest report for given cluster</p>
</td>
	<td class="code"><pre><code>	<div class="ident">query</div> <div class="operator">:=</div> <div class="literal">`
		SELECT report, updated_at
		  FROM new_reports
		 WHERE org_id = $1 AND cluster = $2
		 ORDER BY updated_at DESC
		 LIMIT 1
                `</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="ident">query</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">report</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">updatedAt</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">report</div><div class="operator">,</div> <div class="ident">updatedAt</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">report</div><div class="operator">,</div> <div class="ident">updatedAt</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>WriteNotificationRecord method writes a report (with given state and
notification type) into the database table <code>reported</code>. Data for several
columns are passed via NotificationRecord structure.</p>

<p>See also: WriteNotificationRecordForCluster, WriteNotificationRecordImpl</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">WriteNotificationRecord</div><div class="operator">(</div>
	<div class="ident">notificationRecord</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">NotificationRecord</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>

	<div class="keyword">return</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">WriteNotificationRecordImpl</div><div class="operator">(</div><div class="ident">notificationRecord</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">notificationRecord</div><div class="operator">.</div><div class="ident">AccountNumber</div><div class="operator">,</div> <div class="ident">notificationRecord</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">notificationRecord</div><div class="operator">.</div><div class="ident">NotificationTypeID</div><div class="operator">,</div> <div class="ident">notificationRecord</div><div class="operator">.</div><div class="ident">StateID</div><div class="operator">,</div>
		<div class="ident">notificationRecord</div><div class="operator">.</div><div class="ident">Report</div><div class="operator">,</div> <div class="ident">notificationRecord</div><div class="operator">.</div><div class="ident">UpdatedAt</div><div class="operator">,</div>
		<div class="ident">notificationRecord</div><div class="operator">.</div><div class="ident">NotifiedAt</div><div class="operator">,</div> <div class="ident">notificationRecord</div><div class="operator">.</div><div class="ident">ErrorLog</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>WriteNotificationRecordImpl method writes a report (with given state and
notification type) into the database table <code>reported</code>. Data for all columns
are passed explicitly.</p>

<p>See also: WriteNotificationRecord, WriteNotificationRecordForCluster</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">WriteNotificationRecordImpl</div><div class="operator">(</div>
	<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
	<div class="ident">accountNumber</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">AccountNumber</div><div class="operator">,</div>
	<div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
	<div class="ident">notificationTypeID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">NotificationTypeID</div><div class="operator">,</div>
	<div class="ident">stateID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">StateID</div><div class="operator">,</div>
	<div class="ident">report</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">,</div>
	<div class="ident">updatedAt</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">,</div>
	<div class="ident">notifiedAt</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">,</div>
	<div class="ident">errorLog</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>

	<div class="keyword">const</div> <div class="ident">insertStatement</div> <div class="operator">=</div> <div class="literal">`
            INSERT INTO reported
            (org_id, account_number, cluster, notification_type, state, report, updated_at, notified_at, error_log)
            VALUES
            ($1, $2, $3, $4, $5, $6, $7, $8, $9)
        `</div><div class="operator"></div>
	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">insertStatement</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div>
		<div class="ident">accountNumber</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div> <div class="ident">notificationTypeID</div><div class="operator">,</div> <div class="ident">stateID</div><div class="operator">,</div>
		<div class="ident">report</div><div class="operator">,</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator">(</div><div class="ident">updatedAt</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator">(</div><div class="ident">notifiedAt</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">errorLog</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>WriteNotificationRecordForCluster method writes a report (with given state
and notification type) into the database table <code>reported</code>. Data for several
columns are passed via ClusterEntry structure (as returned by
ReadReportForClusterAtTime and ReadReportForClusterAtOffset methods).</p>

<p>See also: WriteNotificationRecord, WriteNotificationRecordImpl</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">WriteNotificationRecordForCluster</div><div class="operator">(</div>
	<div class="ident">clusterEntry</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterEntry</div><div class="operator">,</div>
	<div class="ident">notificationTypeID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">NotificationTypeID</div><div class="operator">,</div>
	<div class="ident">stateID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">StateID</div><div class="operator">,</div>
	<div class="ident">report</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">,</div>
	<div class="ident">notifiedAt</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">,</div>
	<div class="ident">errorLog</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>

	<div class="keyword">return</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">WriteNotificationRecordImpl</div><div class="operator">(</div><div class="ident">clusterEntry</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">clusterEntry</div><div class="operator">.</div><div class="ident">AccountNumber</div><div class="operator">,</div> <div class="ident">clusterEntry</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">notificationTypeID</div><div class="operator">,</div> <div class="ident">stateID</div><div class="operator">,</div> <div class="ident">report</div><div class="operator">,</div> <div class="ident">clusterEntry</div><div class="operator">.</div><div class="ident">UpdatedAt</div><div class="operator">,</div>
		<div class="ident">notifiedAt</div><div class="operator">,</div> <div class="ident">errorLog</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ReadLastNNotificationRecords method returns the last N notification records
for given org ID and cluster name.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">ReadLastNNotificationRecords</div><div class="operator">(</div><div class="ident">clusterEntry</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterEntry</div><div class="operator">,</div>
	<div class="ident">numberOfRecords</div> <div class="ident">int</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">NotificationRecord</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">notificationRecords</div> <div class="operator">=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">NotificationRecord</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">query</div> <div class="operator">:=</div> <div class="literal">`
                  select org_id, account_number, cluster, notification_type, state, report, updated_at, notified_at, error_log
		    from reported
		   where org_id = $1 and cluster = $2
		   order by notified_at desc
		   limit $3;
		   `</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="ident">query</div><div class="operator">,</div> <div class="ident">clusterEntry</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">clusterEntry</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div> <div class="ident">numberOfRecords</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">notificationRecords</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">unableToCloseDBRowsHandle</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="operator">(</div>
			<div class="ident">orgID</div>              <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator"></div>
			<div class="ident">accountNumber</div>      <div class="ident">types</div><div class="operator">.</div><div class="ident">AccountNumber</div><div class="operator"></div>
			<div class="ident">clusterName</div>        <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator"></div>
			<div class="ident">updatedAt</div>          <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator"></div>
			<div class="ident">notificationTypeID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">NotificationTypeID</div><div class="operator"></div>
			<div class="ident">stateID</div>            <div class="ident">types</div><div class="operator">.</div><div class="ident">StateID</div><div class="operator"></div>
			<div class="ident">report</div>             <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator"></div>
			<div class="ident">notifiedAt</div>         <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator"></div>
			<div class="ident">errorLog</div>           <div class="ident">string</div><div class="operator"></div>
		<div class="operator">)</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">orgID</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">accountNumber</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">clusterName</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">notificationTypeID</div><div class="operator">,</div>
			<div class="operator">&amp;</div><div class="ident">stateID</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">report</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">updatedAt</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">notifiedAt</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">errorLog</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">if</div> <div class="ident">closeErr</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">closeErr</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">closeErr</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">unableToCloseDBRowsHandle</div><div class="operator">)</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">notificationRecords</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
		<div class="ident">notificationRecords</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">notificationRecords</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">NotificationRecord</div><div class="operator">{</div>
			<div class="ident">OrgID</div><div class="operator">:</div>              <div class="ident">orgID</div><div class="operator">,</div>
			<div class="ident">AccountNumber</div><div class="operator">:</div>      <div class="ident">accountNumber</div><div class="operator">,</div>
			<div class="ident">ClusterName</div><div class="operator">:</div>        <div class="ident">clusterName</div><div class="operator">,</div>
			<div class="ident">UpdatedAt</div><div class="operator">:</div>          <div class="ident">updatedAt</div><div class="operator">,</div>
			<div class="ident">NotificationTypeID</div><div class="operator">:</div> <div class="ident">notificationTypeID</div><div class="operator">,</div>
			<div class="ident">StateID</div><div class="operator">:</div>            <div class="ident">stateID</div><div class="operator">,</div>
			<div class="ident">Report</div><div class="operator">:</div>             <div class="ident">report</div><div class="operator">,</div>
			<div class="ident">NotifiedAt</div><div class="operator">:</div>         <div class="ident">notifiedAt</div><div class="operator">,</div>
			<div class="ident">ErrorLog</div><div class="operator">:</div>           <div class="ident">errorLog</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">notificationRecords</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>CleanupForOrganization method deletes all reports older than specified
relative time for given organization ID.</p>

<p>This method is to be used to cleanup older reports after weekly summary is
sent.</p>

<p>The method return number of deleted records.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">CleanupForOrganization</div><div class="operator">(</div><div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">maxAge</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">statement</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">int</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">printableStatement</div> <div class="operator">:=</div> <div class="ident">getPrintableStatement</div><div class="operator">(</div><div class="ident">statement</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="ident">MaxAgeAttribute</div><div class="operator">,</div> <div class="ident">maxAge</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;delete statement&#34;</div><div class="operator">,</div> <div class="ident">printableStatement</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int</div><div class="operator">(</div><div class="ident">OrgIDMessage</div><div class="operator">,</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Cleanup operation&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>perform the SQL statement</p>
</td>
	<td class="code"><pre><code>	<div class="ident">result</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">statement</div><div class="operator">,</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">maxAge</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="literal">0</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>read number of affected (deleted) rows</p>
</td>
	<td class="code"><pre><code>	<div class="ident">affected</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">result</div><div class="operator">.</div><div class="ident">RowsAffected</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="literal">0</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">affected</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>CleanupNewReportsForOrganization method deletes all reports from
<code>new_reports</code> table older than specified relative time. Delete operation is
restricted for given organization ID.</p>

<p>This method is to be used to cleanup older reports after weekly summary is
sent.</p>

<p>The method return number of deleted records.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">CleanupNewReportsForOrganization</div><div class="operator">(</div><div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">maxAge</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">int</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">sqlStatement</div> <div class="operator">:=</div> <div class="ident">deleteOldRecordsFromNewReportsTable</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">CleanupForOrganization</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">,</div> <div class="ident">maxAge</div><div class="operator">,</div> <div class="ident">sqlStatement</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>CleanupOldReportsForOrganization method deletes all reports from <code>reported</code>
table older than specified relative time. Delete operation is restricted for
given organization ID.</p>

<p>This method is to be used to cleanup older reports after weekly summary is
sent.</p>

<p>The method return number of deleted records.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">CleanupOldReportsForOrganization</div><div class="operator">(</div><div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">maxAge</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">int</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">sqlStatement</div> <div class="operator">:=</div> <div class="ident">deleteOldRecordsFromReportedTable</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">CleanupForOrganization</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">,</div> <div class="ident">maxAge</div><div class="operator">,</div> <div class="ident">sqlStatement</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>getPrintableStatement returns SQL statement in form prepared for logging</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">getPrintableStatement</div><div class="operator">(</div><div class="ident">sqlStatement</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">string</div> <div class="operator">{</div>
	<div class="ident">s</div> <div class="operator">:=</div> <div class="ident">strings</div><div class="operator">.</div><div class="ident">Replace</div><div class="operator">(</div><div class="ident">sqlStatement</div><div class="operator">,</div> <div class="literal">&#34;\n&#34;</div><div class="operator">,</div> <div class="literal">&#34; &#34;</div><div class="operator">,</div> <div class="operator">-</div><div class="literal">1</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">s</div> <div class="operator">=</div> <div class="ident">strings</div><div class="operator">.</div><div class="ident">Replace</div><div class="operator">(</div><div class="ident">s</div><div class="operator">,</div> <div class="literal">&#34;\t&#34;</div><div class="operator">,</div> <div class="literal">&#34;&#34;</div><div class="operator">,</div> <div class="operator">-</div><div class="literal">1</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">strings</div><div class="operator">.</div><div class="ident">Trim</div><div class="operator">(</div><div class="ident">s</div><div class="operator">,</div> <div class="literal">&#34; &#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
    </tbody>
  </table>
</div>
</body>
</html>
